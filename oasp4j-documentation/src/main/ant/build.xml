<project name="pre-process-asciidoc" default="main" basedir=".">
  <description>Pre-process asciidocs to make inter wiki link references work in single page document.</description>

  <target name="main">
    <foreach target="pre-process-asciidoc" param="asciidoc-file" inheritall="true">
      <path>
        <fileset dir="${oasp4j.asciidoc.source}" casesensitive="yes">
          <include name="**/*.asciidoc"/>
        </fileset>
      </path>
    </foreach>
    <copy todir="${basedir}/target/docbook/">
      <path>
        <fileset dir="${oasp4j.asciidoc.source}">
          <exclude name="**/*.asciidoc"/>
        </fileset>
      </path>
    </copy>
  </target>
  <target name="pre-process-asciidoc">
    <basename property="filename" file="${asciidoc-file}" suffix=".asciidoc"/>
    <copy file="${asciidoc-file}" todir="${oasp4j.asciidoc.target}">
      <filterchain>
        <tokenfilter>
          <linetokenizer/>
          <replaceregex pattern="^(==+) (.*)" replace="[[${filename}_\2]]${line.separator}\1 \2" flags="g"/>
          <replaceregex pattern="^(=) (.*)" replace="[[${filename}]]${line.separator}\1 \2" flags="g"/>
          <!--
          <replaceregex pattern="include\:\:([^.]*)" replace="[[\1]]${line.separator}include::\1" flags="g"/>
          -->
          <replaceregex pattern="xref:(\w*)" replace="xref:${filename}_\1" flags="g"/>
          <replaceregex pattern="link:([^#:]*)\[" replace="xref:\1[" flags="g"/>
          <replaceregex pattern="link:([^#:]*)#(\w*)" replace="xref:\1_\2" flags="g"/>
          <scriptfilter language="javascript">
            var text = self.getToken();
            if (text.startsWith('[[')) {
              var index = text.indexOf(']]');
              self.setToken(text.substring(0, index).toLowerCase().replace(' ','-') + text.substring(index));
            }
          </scriptfilter>
        </tokenfilter>
      </filterchain>
    </copy>
    <!--
    <replaceregexp file="${asciidoc-file}" byline="true">
      <regexp pattern="^(=)+ (.*)"/>
      <substitution expression="\1 \2${line.separator}[[\L2]]"/>
    </replaceregexp>
    <replaceregexp file="${asciidoc-file}">
      <regexp pattern="xref:(\w)"/>
      <substitution expression="xref:${filename}_\1"/>
    </replaceregexp>
    <replaceregexp file="${asciidoc-file}">
      <regexp pattern="link:([^\[#:]*)"/>
      <substitution expression="xref:\1"/>
    </replaceregexp>
    <replaceregexp file="${asciidoc-file}">
      <regexp pattern="link:(\w)[#](\w)"/>
      <substitution expression="xref:\1_\2"/>
    </replaceregexp>
    -->
  </target>
</project>